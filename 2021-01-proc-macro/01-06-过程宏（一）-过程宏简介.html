<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>（一）过程宏简介 - Rust中文博客</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../overview.html">序言</a></li><li class="chapter-item expanded affix "><li class="part-title">2022-01</li><li class="chapter-item expanded "><a href="../2022-01-polonius/00.html">Polonius学习笔记</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../2022-01-polonius/01-21-借用检查（零）-原子式与输入.html">（零）原子式与输入</a></li><li class="chapter-item expanded "><a href="../2022-01-polonius/01-21-借用检查（一）-初始化分析.html">（一）初始化分析</a></li><li class="chapter-item expanded "><a href="../2022-01-polonius/01-23-借用检查（二）-存活性分析.html">（二）存活性分析</a></li><li class="chapter-item expanded "><a href="../2022-01-polonius/02-08-借用检查（三）-借债分析.html">（三）借债分析</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../2022-01-polonius/02-08-借用检查（三）-借债分析-原始规则.html">(1) 原始规则</a></li><li class="chapter-item expanded "><div>(2) 位置无关规则</div></li><li class="chapter-item expanded "><div>(3) 优化规则</div></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">2021-09</li><li class="chapter-item expanded "><a href="../2021-09-ghost-cell/09-03-ghost-cell.html">Ghost Cell试用体验</a></li><li class="chapter-item expanded affix "><li class="part-title">2021-01</li><li class="chapter-item expanded "><a href="../2021-01-proc-macro/00.html">Rust过程宏入门系列</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../2021-01-proc-macro/01-06-过程宏（一）-过程宏简介.html" class="active">（一）过程宏简介</a></li><li class="chapter-item expanded "><a href="../2021-01-proc-macro/01-07-过程宏（二）-初探派生宏.html">（二）初探派生宏</a></li><li class="chapter-item expanded "><a href="../2021-01-proc-macro/01-10-过程宏（三）-实现简易派生宏.html">（三）实现简易派生宏</a></li><li class="chapter-item expanded "><a href="../2021-01-proc-macro/01-16-过程宏（四）-遍历结构体字段.html">（四）遍历结构体字段</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust中文博客</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/frank-king/rustblog-zh" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rust过程宏入门一过程宏简介"><a class="header" href="#rust过程宏入门一过程宏简介">Rust过程宏入门（一）——过程宏简介</a></h1>
<p>写于2021年1月6日。最早发表于<a href="https://zhuanlan.zhihu.com/p/342408254">知乎</a>。</p>
<h2 id="什么是宏"><a class="header" href="#什么是宏">什么是宏？</a></h2>
<p>熟悉C/C++的朋友应该很熟悉 <strong>宏（Macro）</strong> 的概念，而Rust初学者也必定会接触到Rust中的宏，其Hello world程序中就会用到<code>println!</code>宏。</p>
<p>可以简单地理解为： <strong>宏即编译时将执行的一系列指令</strong>。其重点在于「编译时」，尽管宏与函数（或方法）形似，函数是在运行时发生调用的，而宏是在编译时执行的。</p>
<p>不同于C/C++中的宏，Rust的宏并非简单的文本替换，而是在词法层面甚至语法树层面作替换，其功能更加强大，也更加安全。</p>
<p>如下所示的一个C++的宏SQR的定义</p>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#define SQR(x) (x * x)
int main() {
    std::cout &lt;&lt; SQR(1 + 1) &lt;&lt; std::endl;
    return 0;
} 
</code></pre>
<p>我们希望它输出<code>4</code>，但很遗憾它将输出<code>3</code>，因为<code>SQR(1 + 1)</code>在预编译阶段通过文本替换展开将得到<code>(1 + 1 * 1 + 1)</code>，并非我们所期望的语义。</p>
<p>而在Rust中，按如下方式定义的宏：</p>
<pre><pre class="playground"><code class="language-rust edition2021">macro_rules! sqr {
    ($x:expr) =&gt; {$x * $x}
}

fn main() {
    println!(&quot;{}&quot;, sqr!(1 + 1));
}
</code></pre></pre>
<p>将得到正确的答案<code>4</code>。这是因为Rust的宏展开发生在语法分析阶段，此时编译器知道<code>sqr!</code>宏中的<code>$x</code>变量是一个表达式（用<code>$x:expr</code>标记），所以在展开后它知道如何正确处理，会将其展开为<code>((1 + 1) * (1 + 1))</code>。</p>
<p>由于本文介绍的重点是过程宏，因此涉及普通宏的内容便不多赘述，有兴趣者可参考<a href="https://doc.rust-lang.org/rust-by-example/macros.html">官方文档</a>上的介绍。</p>
<h2 id="什么是过程宏"><a class="header" href="#什么是过程宏">什么是过程宏？</a></h2>
<p><strong>过程宏（Procedure Macro）</strong> 是Rust中的一种特殊形式的宏，它将提供比普通宏更强大的功能。方便起见，本文将Rust中由<code>macro_rules!</code>定义的宏称为 <strong>声明宏</strong> 以示区分。</p>
<p>过程宏分为三种：</p>
<ul>
<li>派生宏（Derive macro）：用于结构体（struct）、枚举（enum）、联合（union）类型，可为其实现函数或特征（Trait）。</li>
<li>属性宏（Attribute macro）：用在结构体、字段、函数等地方，为其指定属性等功能。如标准库中的<code>#[inline]</code>、<code>#[derive(...)]</code>等都是属性宏。</li>
<li>函数式宏（Function-like macro）：用法与普通的声明宏类似，但功能更加强大，可实现任意语法树层面的转换功能。</li>
</ul>
<h2 id="过程宏的定义与使用方法"><a class="header" href="#过程宏的定义与使用方法">过程宏的定义与使用方法</a></h2>
<h3 id="派生宏"><a class="header" href="#派生宏">派生宏</a></h3>
<p>派生宏的定义方法如下：</p>
<pre><code class="language-rust ignore">#[proc_macro_derive(Builder)]
fn derive_builder(input: TokenStream) -&gt; TokenStream {
    let _ = input;

    unimplemented!()
}
</code></pre>
<p>其使用方法如下：</p>
<pre><code class="language-rust ignore">#[derive(Builder)]
struct Command {
    // ...
}
</code></pre>
<h3 id="属性宏"><a class="header" href="#属性宏">属性宏</a></h3>
<p>属性宏的定义方法如下：</p>
<pre><code class="language-rust ignore">#[proc_macro_attribute]
fn sorted(args: TokenStream, input: TokenStream) -&gt; TokenStream {
    let _ = args;
    let _ = input;

    unimplemented!()
}
</code></pre>
<p>使用方法如下：</p>
<pre><code class="language-rust ignore">#[sorted]
enum Letter {
    A,
    B,
    C,
    // ...
}
</code></pre>
<h3 id="函数式宏"><a class="header" href="#函数式宏">函数式宏</a></h3>
<p>函数式宏的定义方法如下：</p>
<pre><code class="language-rust ignore">#[proc_macro]
pub fn seq(input: TokenStream) -&gt; TokenStream {
    let _ = input;

    unimplemented!()
}
</code></pre>
<p>使用方法如下：</p>
<pre><code class="language-rust ignore">seq! { n in 0..10 {
    /* ... */
}}
</code></pre>
<h2 id="过程宏的原理"><a class="header" href="#过程宏的原理">过程宏的原理</a></h2>
<p>以上三种过程宏的定义方法已全部介绍。可以发现，它的定义方式与普通函数无异，只不过其函数调用发生在编译阶段而已。下面以较为常见的派生宏为例，介绍过程宏的原理。</p>
<p>回顾刚才的定义：</p>
<pre><code class="language-rust ignore">#[proc_macro_derive(Builder)]
fn derive_builder(input: TokenStream) -&gt; TokenStream {
    let _ = input;

    unimplemented!()
}
</code></pre>
<p>首先，<code>#[proc_macro_derive(Builder)]</code>表明<code>derive_builder</code>是一个派生宏，<code>Builder</code>表示它将作用的地方。比如定义如下结构体</p>
<pre><code class="language-rust ignore">#[derive(Builder)]
struct Command {
    // ...
}
</code></pre>
<p>就会触发以上派生宏执行。至于其中的<code>Builder</code>具体代表什么含义，本期暂不展开，后面再详细介绍。</p>
<p><code>fn derive_builder(input: TokenStream) -&gt; TokenStream</code>函数头部表明该函数将接受一个<code>TokenStream</code>对象作为输入，并返回一个<code>TokenStream</code>对象。</p>
<p>要理解<code>TokenStream</code>，需要一些简单的编译原理知识。编译器在编译一段程序时，会首先将输入的文本转换成一系列的Token（标识符、关键字、符号、字面量等），同时忽略注释（文档注释除外）与空白字符等。</p>
<p>例如<code>println!(&quot;Hello world&quot;);</code>这句代码将被转换成标识符<code>println</code> 、叹号<code>!</code> 、圆括号<code>(</code> 、字面量<code>&quot;Hello world&quot;</code> 、圆括号<code>)</code> 、分号<code>;</code>几个Token。</p>
<p><code>TokenStream</code>顾名思义，是Rust中对一系列连续的Token的抽象。在宏展开的过程中，遇到派生宏时，会将整个结构体（或<code>enum</code>、<code>union</code>）展开成<code>TokenStream</code>作为派生宏函数的输入，然后将其输出的<code>TokenStream</code>附加到结构体后面，再继续作语法分析。</p>
<hr />
<p>本期的介绍到此结束，主要介绍了过程宏的基本概念、定义及使用方法、实现原理。接下来将通过几个具体实例详细介绍Rust过程宏的编程方法。</p>
<p>实例来源自GitHub上的仓库： <a href="https://github.com/dtolnay/proc-macro-workshop/%E2%80%8B">dtolnay/proc-macro-workshop</a>。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../2021-01-proc-macro/00.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../2021-01-proc-macro/01-07-过程宏（二）-初探派生宏.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../2021-01-proc-macro/00.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../2021-01-proc-macro/01-07-过程宏（二）-初探派生宏.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script src="https://utteranc.es/client.js"
                repo="frank-king/rustblog-zh"
                issue-term="title"
                theme="github-dark"
                crossorigin="anonymous"
                async>
        </script>

    </body>
</html>
